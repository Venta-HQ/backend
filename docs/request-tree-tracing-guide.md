# üîç Request Tree Tracing in Grafana

## üìã Table of Contents

- [Overview](#overview)
- [Request ID Propagation Architecture](#request-id-propagation-architecture)
- [Grafana Query Strategies](#grafana-query-strategies)
- [Complete Request Tree Dashboard](#complete-request-tree-dashboard)
- [Advanced Query Patterns](#advanced-query-patterns)
- [Troubleshooting](#troubleshooting)
- [Best Practices](#best-practices)

## üéØ Overview

This guide explains how to query and visualize complete request trees across your Venta backend microservices using Grafana. Your system has excellent request ID propagation from HTTP ‚Üí gRPC ‚Üí Events ‚Üí Logs, making it possible to trace entire request flows end-to-end.

## üèóÔ∏è Request ID Propagation Architecture

### **Request Flow Pattern**

```
HTTP Request (Gateway)
    ‚Üì (x-request-id header)
gRPC Call (Gateway ‚Üí Service)
    ‚Üì (requestId metadata)
Service Processing
    ‚Üì (RequestContextService)
Event Emission
    ‚Üì (correlationId = requestId)
Event Processing
    ‚Üì (correlationId in logs)
Complete Trace
```

### **Key Components**

| Component | Location | Purpose |
|-----------|----------|---------|
| **HTTP Request ID** | `x-request-id` header | Generated by Pino, propagated to gRPC |
| **gRPC Metadata** | `requestId` in metadata | Passed between services |
| **Request Context** | `RequestContextService` | Stores request ID for gRPC services |
| **Event Correlation** | `correlationId` field | Same as request ID for tracing |
| **Log Labels** | Loki `requestId` label | Enables log correlation |

## üîç Grafana Query Strategies

### **1. Log-Based Request Tree (Loki)**

#### **Complete Request Flow**
```promql
# Basic request ID search across all services
{app=~"gateway|user|vendor|location|algolia-sync|websocket-gateway"} |= "requestId=req-123"
```

#### **Timeline View**
```promql
# Chronological view with service names
{app=~".*"} |= "requestId=req-123" | json | line_format "{{.timestamp}} [{{.app}}] {{.msg}}"
```

#### **Service-Specific Filtering**
```promql
# Gateway only
{app="gateway"} |= "requestId=req-123"

# gRPC services only
{app=~"user|vendor|location"} |= "requestId=req-123"

# Event processors only
{app=~"algolia-sync|websocket-gateway"} |= "requestId=req-123"
```

### **2. Event-Based Correlation (NATS Events)**

#### **Event Flow Tracking**
```promql
# Find all events for a correlation ID
{app=~".*"} |= "correlationId=req-123" | json
```

#### **Event Source Tracking**
```promql
# Track event flow with source service
{app=~".*"} |= "correlationId=req-123" | json | line_format "{{.timestamp}} {{.source}} ‚Üí {{.msg}}"
```

#### **Event Type Filtering**
```promql
# Specific event types
{app=~".*"} |= "correlationId=req-123" |= "vendor.created" | json
```

### **3. Protocol-Specific Queries**

#### **HTTP Request Tracking**
```promql
# HTTP requests in gateway
{app="gateway"} |= "requestId=req-123" |= "HTTP" | json
```

#### **gRPC Call Tracking**
```promql
# gRPC calls between services
{app=~"gateway|user|vendor|location"} |= "requestId=req-123" |= "gRPC" | json
```

#### **WebSocket Events**
```promql
# WebSocket-related events
{app="websocket-gateway"} |= "requestId=req-123" | json
```

### **4. Error and Performance Tracking**

#### **Error Tracking**
```promql
# Errors for specific request
{app=~".*"} |= "requestId=req-123" |= "error" | json
```

#### **Performance Issues**
```promql
# Slow requests
{app=~".*"} |= "requestId=req-123" |= "duration" | json
```

## üìä Complete Request Tree Dashboard

### **Dashboard Features**

The `request-tree-dashboard.json` provides:

1. **Request ID Input**: Variable for entering request IDs
2. **Complete Timeline**: All logs for the request across services
3. **Event Flow**: NATS events with correlation IDs
4. **Service Interaction Map**: Which services were involved
5. **Performance Metrics**: Request duration by service
6. **Error Tracking**: Any errors in the request flow
7. **Protocol Breakdown**: HTTP vs gRPC calls

### **Usage Instructions**

1. **Import Dashboard**: Import `request-tree-dashboard.json` into Grafana
2. **Enter Request ID**: Use the variable input to enter a request ID
3. **View Complete Flow**: See the entire request tree across all services
4. **Analyze Performance**: Identify bottlenecks and errors

## üîß Advanced Query Patterns

### **1. Request Pattern Analysis**

#### **Find Similar Requests**
```promql
# Find requests with similar patterns
{app="gateway"} |= "POST /vendors" | json | line_format "{{.requestId}}"
```

#### **Request Frequency**
```promql
# Count requests by endpoint
count by (route) ({app="gateway"} |= "requestId")
```

### **2. Cross-Service Dependencies**

#### **Service Call Patterns**
```promql
# Which services call which other services
{app=~".*"} |= "gRPC call to" | json | line_format "{{.app}} ‚Üí {{.msg}}"
```

#### **Event Dependencies**
```promql
# Event flow between services
{app=~".*"} |= "correlationId" | json | line_format "{{.source}} ‚Üí {{.msg}}"
```

### **3. Performance Analysis**

#### **Request Duration Distribution**
```promql
# Duration percentiles by service
histogram_quantile(0.95, rate(request_duration_seconds_bucket[5m]))
```

#### **Service Latency**
```promql
# Average latency by service
rate(request_duration_seconds_sum[5m]) / rate(request_duration_seconds_count[5m])
```

### **4. Error Analysis**

#### **Error Rate by Service**
```promql
# Error rate for specific request patterns
rate(requests_total{status_code=~"5.."}[5m]) / rate(requests_total[5m])
```

#### **Error Correlation**
```promql
# Find related errors
{app=~".*"} |= "error" |= "requestId=req-123" | json
```

## üö® Troubleshooting

### **Common Issues**

| Issue | Solution |
|-------|----------|
| **No logs found** | Check if request ID exists in logs |
| **Missing services** | Verify all services are logging with request IDs |
| **Event correlation missing** | Ensure events have correlation IDs |
| **Timeline gaps** | Check for service restarts or network issues |

### **Debugging Steps**

1. **Verify Request ID Generation**
   ```promql
   {app="gateway"} |= "x-request-id" | json
   ```

2. **Check gRPC Propagation**
   ```promql
   {app=~"user|vendor|location"} |= "requestId" | json
   ```

3. **Validate Event Correlation**
   ```promql
   {app=~".*"} |= "correlationId" | json
   ```

4. **Check Log Labels**
   ```promql
   {app=~".*"} | json | line_format "{{.requestId}} {{.correlationId}}"
   ```

### **Verification Queries**

#### **Request ID Presence**
```promql
# Check if request IDs are being logged
count by (app) ({app=~".*"} |= "requestId")
```

#### **Correlation ID Presence**
```promql
# Check if correlation IDs are being logged
count by (app) ({app=~".*"} |= "correlationId")
```

#### **Service Coverage**
```promql
# Verify all services are logging
count by (app) ({app=~".*"})
```

## üéØ Best Practices

### **1. Query Optimization**

- **Use specific app filters** to reduce query scope
- **Leverage log labels** for faster filtering
- **Use time ranges** to limit data volume
- **Combine with metrics** for performance insights

### **2. Dashboard Design**

- **Start with timeline view** for complete overview
- **Add service-specific panels** for detailed analysis
- **Include error tracking** for troubleshooting
- **Use variables** for easy request ID input

### **3. Monitoring Strategy**

- **Set up alerts** for missing request IDs
- **Monitor correlation ID propagation**
- **Track request completion rates**
- **Alert on error patterns**

### **4. Performance Considerations**

- **Limit time ranges** for large request trees
- **Use log aggregation** for high-volume services
- **Cache frequently accessed request IDs**
- **Optimize log retention** for tracing needs

## üìà Example Request Tree Analysis

### **Vendor Creation Request Flow**

```
1. HTTP Request: POST /vendors (Gateway)
   - Request ID: req-123
   - Duration: 50ms

2. gRPC Call: createVendor (Gateway ‚Üí Vendor)
   - Request ID: req-123
   - Duration: 200ms

3. Database Operation (Vendor Service)
   - Request ID: req-123
   - Duration: 150ms

4. Event Emission: vendor.created (Vendor)
   - Correlation ID: req-123
   - Duration: 10ms

5. Event Processing: vendor.created (Algolia Sync)
   - Correlation ID: req-123
   - Duration: 300ms

Total Request Tree Duration: 710ms
```

### **Grafana Query for This Flow**

```promql
# Complete vendor creation flow
{app=~"gateway|vendor|algolia-sync"} |= "requestId=req-123" | json | line_format "{{.timestamp}} [{{.app}}] {{.msg}}"
```

## üîó Integration with Existing Dashboards

### **Combine with Metrics**

- **Request duration metrics** from Prometheus
- **Error rate metrics** for correlation
- **Service health metrics** for context

### **Alert Integration**

- **Request timeout alerts** based on duration
- **Error rate alerts** for specific request patterns
- **Service dependency alerts** for missing calls

---

**This request tree tracing system provides complete visibility into your distributed microservices architecture, enabling effective debugging, performance optimization, and operational monitoring.** 